@page "/login"
@inject HttpClient Http
@inject NavigationManager Navigation
@using PortalProveedores.Web.Models

<PageTitle>Login - Portal Proveedores</PageTitle>

<h1>Iniciar Sesión</h1>
<hr />

<EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }

    <div class="form-group">
        <label for="username">Usuario:</label>
        <InputText id="username" @bind-Value="loginModel.Username" class="form-control" />
    </div>

    <div class="form-group">
        <label for="password">Contraseña:</label>
        <InputText id="password" @bind-Value="loginModel.Password" type="password" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary mt-3" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true">Cargando...</span>
        }
        else
        {
            <span>Login</span>
        }
    </button>
</EditForm>


@code {
    private LoginRequest loginModel = new LoginRequest();
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    // Tu URL API verificada
    private const string ApiUrl = "https://localhost:7061/api/Authentication/Login"; 

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;
        
        try
        {
            var response = await Http.PostAsJsonAsync(ApiUrl, loginModel);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                
                // *** Aquí se manejaría el almacenamiento del Token (ej: LocalStorage) ***
                // Este token luego se enviaría en los headers de futuras peticiones a la API
                Console.WriteLine($"Token recibido: {result?.Token}");
                Console.WriteLine($"Expiración: {result?.Expiration}");

                Navigation.NavigateTo("/"); // Redirigir a la página principal después del login
            }
            else
            {
                // Leer el mensaje de error de la API si está disponible
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Inicio de sesión fallido: {response.StatusCode}. Detalles: {errorContent}";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Error de conexión con la API: {ex.Message}. Asegúrese que la API esté corriendo en {ApiUrl}.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Ocurrió un error inesperado: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}